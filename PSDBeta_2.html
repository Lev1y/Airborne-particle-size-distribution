<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- saved from url=(0061)file:///C:/Users/e0154425/Desktop/Lan0826/html/PSDBeta_2.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Airborne particle size distribution (PSD) data processing</title><meta name="generator" content="MATLAB 9.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-08-30"><meta name="DC.source" content="PSDBeta_2.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Airborne particle size distribution (PSD) data processing</h1><!--introduction--><pre>Version: Beta_1.0
Created on 26-Aug-2019
Version: Beta_1.0
Authur: Yang Xuan</pre><!--/introduction--><h2>Contents</h2><div><ul><li><a href="file:///C:/Users/e0154425/Desktop/Lan0826/html/PSDBeta_2.html#1">Licence</a></li><li><a href="file:///C:/Users/e0154425/Desktop/Lan0826/html/PSDBeta_2.html#2">Cautions</a></li><li><a href="file:///C:/Users/e0154425/Desktop/Lan0826/html/PSDBeta_2.html#3">Load spreadsheet</a></li><li><a href="file:///C:/Users/e0154425/Desktop/Lan0826/html/PSDBeta_2.html#4">Data processing</a></li><li><a href="file:///C:/Users/e0154425/Desktop/Lan0826/html/PSDBeta_2.html#5">Export spreadsheet</a></li><li><a href="file:///C:/Users/e0154425/Desktop/Lan0826/html/PSDBeta_2.html#6">Update and support</a></li></ul></div><h2 id="1">Licence</h2><p>MIT License</p><p>Copyright (c) 2019 Yang Xuan</p><p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p><p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p><p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p><h2 id="2">Cautions</h2><div><ul><li><b>YOU MUST IMPORT DATA BEFORE RUNNING THIS CODE</b></li><li>Import data type: Numeriic matrix</li><li>Excluded rows with: Unimportant cells</li><li>An exercise can be dowload in <a href="file:///C:/Users/e0154425/Desktop/Lan0826/html/test_demo">test_demo</a></li></ul></div><h2 id="3">Load spreadsheet</h2><pre class="codeinput">rawmat = input(<span class="string">'The filename occoured in Workspace window: '</span>);
</pre><pre class="codeoutput error">Error using input
Cannot call INPUT from EVALC.

Error in PSDBeta_2 (line 37)
rawmat = input('The filename occoured in Workspace window: ');
</pre><h2 id="4">Data processing</h2><pre class="codeinput"><span class="comment">% Formating</span>
rawmat_size = size(rawmat);
set_rownum = input(<span class="string">'Enter the row number in each batch: '</span>);
margin = input(<span class="string">'Enter the tolerant offset(1.0-0) for peak\n (e.g. 0.95 means 5% offset; 0.9 means 10% offset): '</span>);
<span class="keyword">if</span> mod(rawmat_size(1), set_rownum) == 0
    cell_num = rawmat_size(1) / set_rownum;
    msg = [<span class="string">'Total '</span>, num2str(cell_num), <span class="string">' cells are being calculated, please wait...'</span>];
    disp(msg)
    rowDist = zeros(1, cell_num) + set_rownum;
    cell = mat2cell(rawmat, rowDist); <span class="comment">% equally divide raw matrix</span>
    <span class="comment">% (celldisp(cell)) this line for checking the cells</span>

    <span class="comment">% Cell manipulation</span>
    spoilx = [];
    peak_x = [];
    peak_y = [];
    peak_time = [];
    peak_datum = [];
    sequence = [];
    max_peak_x = [];
    max_peak_y = [];
    max_peak_time = [];
    max_peak_datum = [];
    max_sequence = [];
    <span class="keyword">for</span> i = 1:cell_num
        <span class="keyword">if</span> cell{i,1}(1,3) &gt; cell{i,1}(30,3) <span class="comment">% sort cell in sequence of mass ascending</span>
            sort_cell = flip(cell{i,1});
        <span class="keyword">else</span>
            sort_cell = cell{i,1};
        <span class="keyword">end</span>

        <span class="comment">% Find peaks</span>
        x = sort_cell(:,3);
        y = sort_cell(:,4);
        <span class="keyword">if</span> all(diff(x)&gt;0) <span class="comment">% check monotonicity</span>
            [pks, locs] = findpeaks(y, x);
            peak_x = [peak_x; locs];
            peak_y = [peak_y; pks];

            [m, n] = find(y == pks'); <span class="comment">% corresponding time &amp; datum#</span>
            datum = sort_cell(m, 1);
            peak_datum = [peak_datum; datum];
            time = sort_cell(m, 2);
            peak_time = [peak_time; time];

            count = size(pks);
            i_arr = zeros(count(1),1)+i;
            sequence = [sequence; i_arr];

            <span class="comment">% Find max of peaks</span>
            [o,p] = find(y == max(pks));
            <span class="keyword">if</span> y(o-1) &lt; y(o)*margin &amp;&amp; y(o+1) &lt; y(o)*margin <span class="comment">% left &amp; right data both &lt; peak*margin</span>
                max_peak_x = [max_peak_x; max(locs)];
                max_peak_y = [max_peak_y; max(pks)];

            <span class="keyword">elseif</span> y(o-1) &gt; y(o)*margin &amp;&amp; y(o+1) &lt; y(o)*margin <span class="comment">% left &gt; peak*margin, right &lt; peak*margin</span>
                max_peak_x = [max_peak_x; mean([x(o-1),x(o)])];
                max_peak_y = [max_peak_y; mean([y(o-1),y(o)])];

            <span class="keyword">elseif</span> y(o-1) &lt; y(o)*margin &amp;&amp; y(o+1) &gt; y(o)*margin <span class="comment">% left &lt; peak*margin, right &gt; peak*margin</span>
                max_peak_x = [max_peak_x; mean([x(o),x(o+1)])];
                max_peak_y = [max_peak_y; mean([y(o),y(o+1)])];

            <span class="keyword">else</span> <span class="comment">% left &amp; right data both &gt; peak*margin</span>
                max_peak_x = [max_peak_x; mean([x(o-1), x(o), x(o+1)])];
                max_peak_y = [max_peak_y; mean(y(o-1), y(o), y(o+1))];
            <span class="keyword">end</span>

            max_datum = sort_cell(o, 1);
            max_peak_datum = [max_peak_datum; max_datum];
            max_time = sort_cell(o, 2);
            max_peak_time = [max_peak_time; max_time];

            max_sequence = [max_sequence; i];
        <span class="keyword">else</span> <span class="comment">% spoiled data will be replaced with 0</span>
            spoilx = [spoilx, i];
            peak_x = 0;
            peak_y = 0;
            peak_datum = 0;
            peak_time = 0;
            max_peak_x = 0;
            max_peak_y = 0;
            max_peak_datum = 0;
            max_peak_time = 0;
            sequence = [sequence; i];
            max_sequence = [max_sequence; i];
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    peak_tab = array2table([sequence, peak_datum, peak_time, peak_x,<span class="keyword">...</span>
        peak_y], <span class="string">'VariableNames'</span>,{<span class="string">'Set'</span>,<span class="string">'Datum'</span>,<span class="string">'Time'</span>,<span class="string">'Massfg'</span>,<span class="keyword">...</span>
        <span class="string">'Density'</span>});

    max_peak_tab = array2table([max_sequence, max_peak_datum,<span class="keyword">...</span>
        max_peak_time, max_peak_x, max_peak_y], <span class="string">'VariableNames'</span>,<span class="keyword">...</span>
        {<span class="string">'Set'</span>,<span class="string">'Datum'</span>,<span class="string">'Time'</span>,<span class="string">'Max_Massfg'</span>,<span class="string">'Max_Density'</span>});
    msg3 = [<span class="string">'Mass is not stricly incresing, error occured in set: '</span>,<span class="keyword">...</span>
        num2str(spoilx)];
    disp(msg3)
<span class="keyword">else</span>
    msg2 = <span class="string">'Error in sorting data, check your data frame'</span>;
    disp(msg2)
<span class="keyword">end</span>
</pre><h2 id="5">Export spreadsheet</h2><pre class="codeinput">filename = input(<span class="string">'Export result as: '</span>,<span class="string">'s'</span>);
writetable(peak_tab, filename, <span class="string">'FileType'</span>, <span class="string">'spreadsheet'</span>, <span class="string">'Sheet'</span>, 1);
writetable(max_peak_tab, filename, <span class="string">'FileType'</span>, <span class="string">'spreadsheet'</span>, <span class="string">'Sheet'</span>, 2);
</pre><h2 id="6">Update and support</h2><p><b>Beta_2.0 will envolve:</b></p><div><ul><li>User friendly GUI operation pannel</li><li>Multiple files processing function</li><li>Enhancement in stability</li></ul></div><p><a href="file:///C:/Users/e0154425/Desktop/Lan0826/html/-">Your support is my best motivation</a></p><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB® R2018b</a><br></p></div><!--
##### SOURCE BEGIN #####
%%  Airborne particle size distribution (PSD) data processing
%  Version: Beta_1.0
%  Created on 26-Aug-2019
%  Version: Beta_1.0
%  Authur: Yang Xuan

%% Licence
% MIT License
% 
% Copyright (c) 2019 Yang Xuan
% 
% Permission is hereby granted, free of charge, to any person obtaining a copy
% of this software and associated documentation files (the "Software"), to deal
% in the Software without restriction, including without limitation the rights
% to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
% copies of the Software, and to permit persons to whom the Software is
% furnished to do so, subject to the following conditions:
% 
% The above copyright notice and this permission notice shall be included in all
% copies or substantial portions of the Software.
% 
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
% FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
% AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
% LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
% OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
% SOFTWARE.

%% Cautions
% * *YOU MUST IMPORT DATA BEFORE RUNNING THIS CODE* 
% * Import data type: Numeriic matrix 
% * Excluded rows with: Unimportant cells
% * An exercise can be dowload in <test_demo>  

%% Load spreadsheet
rawmat = input('The filename occoured in Workspace window: ');

%% Data processing

% Formating
rawmat_size = size(rawmat);
set_rownum = input('Enter the row number in each batch: ');
margin = input('Enter the tolerant offset(1.0-0) for peak\n (e.g. 0.95 means 5% offset; 0.9 means 10% offset): ');
if mod(rawmat_size(1), set_rownum) == 0 
    cell_num = rawmat_size(1) / set_rownum;
    msg = ['Total ', num2str(cell_num), ' cells are being calculated, please wait...'];
    disp(msg)
    rowDist = zeros(1, cell_num) + set_rownum;
    cell = mat2cell(rawmat, rowDist); % equally divide raw matrix
    % (celldisp(cell)) this line for checking the cells
    
    % Cell manipulation
    spoilx = [];
    peak_x = [];
    peak_y = [];
    peak_time = [];
    peak_datum = [];
    sequence = [];
    max_peak_x = [];
    max_peak_y = [];
    max_peak_time = [];
    max_peak_datum = [];
    max_sequence = [];
    for i = 1:cell_num
        if cell{i,1}(1,3) > cell{i,1}(30,3) % sort cell in sequence of mass ascending
            sort_cell = flip(cell{i,1});
        else
            sort_cell = cell{i,1};
        end
        
        % Find peaks
        x = sort_cell(:,3);
        y = sort_cell(:,4);
        if all(diff(x)>0) % check monotonicity
            [pks, locs] = findpeaks(y, x); 
            peak_x = [peak_x; locs];
            peak_y = [peak_y; pks];
            
            [m, n] = find(y == pks'); % corresponding time & datum#
            datum = sort_cell(m, 1);
            peak_datum = [peak_datum; datum];
            time = sort_cell(m, 2);
            peak_time = [peak_time; time];
            
            count = size(pks);
            i_arr = zeros(count(1),1)+i;
            sequence = [sequence; i_arr];
            
            % Find max of peaks
            [o,p] = find(y == max(pks));
            if y(o-1) < y(o)*margin && y(o+1) < y(o)*margin % left & right data both < peak*margin
                max_peak_x = [max_peak_x; max(locs)];
                max_peak_y = [max_peak_y; max(pks)];
                
            elseif y(o-1) > y(o)*margin && y(o+1) < y(o)*margin % left > peak*margin, right < peak*margin
                max_peak_x = [max_peak_x; mean([x(o-1),x(o)])];
                max_peak_y = [max_peak_y; mean([y(o-1),y(o)])];
            
            elseif y(o-1) < y(o)*margin && y(o+1) > y(o)*margin % left < peak*margin, right > peak*margin
                max_peak_x = [max_peak_x; mean([x(o),x(o+1)])];
                max_peak_y = [max_peak_y; mean([y(o),y(o+1)])];
                
            else % left & right data both > peak*margin
                max_peak_x = [max_peak_x; mean([x(o-1), x(o), x(o+1)])];
                max_peak_y = [max_peak_y; mean(y(o-1), y(o), y(o+1))];
            end
            
            max_datum = sort_cell(o, 1);
            max_peak_datum = [max_peak_datum; max_datum];
            max_time = sort_cell(o, 2);
            max_peak_time = [max_peak_time; max_time];
            
            max_sequence = [max_sequence; i];
        else % spoiled data will be replaced with 0
            spoilx = [spoilx, i];
            peak_x = 0;
            peak_y = 0;
            peak_datum = 0;
            peak_time = 0;
            max_peak_x = 0;
            max_peak_y = 0;
            max_peak_datum = 0;
            max_peak_time = 0;
            sequence = [sequence; i];
            max_sequence = [max_sequence; i];
        end
    end
    peak_tab = array2table([sequence, peak_datum, peak_time, peak_x,...
        peak_y], 'VariableNames',{'Set','Datum','Time','Massfg',...
        'Density'});
    
    max_peak_tab = array2table([max_sequence, max_peak_datum,...
        max_peak_time, max_peak_x, max_peak_y], 'VariableNames',...
        {'Set','Datum','Time','Max_Massfg','Max_Density'});
    msg3 = ['Mass is not stricly incresing, error occured in set: ',...
        num2str(spoilx)];
    disp(msg3)
else
    msg2 = 'Error in sorting data, check your data frame';
    disp(msg2)
end

%% Export spreadsheet
filename = input('Export result as: ','s');
writetable(peak_tab, filename, 'FileType', 'spreadsheet', 'Sheet', 1);
writetable(max_peak_tab, filename, 'FileType', 'spreadsheet', 'Sheet', 2);

%% Update and support
% *Beta_2.0 will envolve:*
%
% * User friendly GUI operation pannel
% * Multiple files processing function
% * Enhancement in stability
%
% <- Your support is my best motivation>
##### SOURCE END #####
--></body></html>